<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover,user-scalable=no" />
  <title>HypeZone Elite — Morocco’s Social Zone by City & Neighborhood</title>
  <meta name="description" content="HypeZone is Morocco’s local social zone to discover rooms by city and neighborhood, post vibes, and meet real people who show up." />
  <meta name="robots" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1" />
  <meta name="theme-color" content="#000000" />
  <link rel="canonical" href="https://hypezone-maroc.vercel.app/" />
  <link rel="icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="HypeZone" />
  <meta property="og:title" content="HypeZone Elite — Morocco’s Social Zone by City & Neighborhood" />
  <meta property="og:description" content="Discover rooms by city and neighborhood in Morocco. Post vibes, find local people, join HypeZone." />
  <meta property="og:url" content="https://hypezone-maroc.vercel.app/" />
  <meta property="og:image" content="https://up6.cc/2026/02/177066115684561.jpg" />
  <meta property="og:image:alt" content="HypeZone cover image" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="HypeZone Elite — Morocco’s Social Zone" />
  <meta name="twitter:description" content="Rooms by city & neighborhood in Morocco. Post vibes, discover real people, join HypeZone." />
  <meta name="twitter:image" content="https://up6.cc/2026/02/177066115684561.jpg" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Courgette&display=swap" rel="stylesheet" />
  <style>
    :root{--bg:#000;--card:#111;--primary:#00d2ff;--text:#fff;--muted:#888;--border:rgba(255,255,255,0.12);--viby:#ffd700;--danger:#ff4757;--success:#2ecc71}
    *{box-sizing:border-box;margin:0;padding:0;outline:0;-webkit-tap-highlight-color:transparent;font-family:'Outfit',sans-serif}
    body{background:var(--bg);color:var(--text);height:100vh;overflow:hidden;-webkit-user-select:none;user-select:none}
    input,textarea,select,button{user-select:auto;-webkit-user-select:auto}
    .hidden{display:none!important}
    svg{display:block;width:24px;height:24px;fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
    .visually-hidden-seo{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0,0,0,0) !important;white-space:nowrap !important;border:0 !important}
    #splash{position:fixed;inset:0;z-index:5000;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,#000 0%, #000 68%, #111 100%)}
    .splash-wrap{width:min(520px,92vw);padding:22px 18px;display:flex;flex-direction:column;align-items:center;gap:14px}
    .splash-title{font-size:44px;font-weight:900;letter-spacing:.6px;color:var(--primary);text-shadow:0 0 22px rgba(0,210,255,.35);line-height:1}
    .splash-sub{font-size:13px;color:rgba(255,255,255,.66);text-align:center;max-width:520px}
    .splash-typing{min-height:54px;display:flex;align-items:center;justify-content:center}
    .cursor{display:inline-block;width:3px;height:34px;background:rgba(0,210,255,.85);margin-left:6px;animation:blink .7s infinite}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
    .splash-bar{width:min(420px,86vw);height:10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);overflow:hidden;box-shadow:0 20px 70px rgba(0,0,0,.75)}
    .splash-fill{height:100%;width:0;border-radius:999px;background:linear-gradient(135deg,#00d2ff,#007aff);animation:splashLoad 1.5s cubic-bezier(.2,.9,.2,1) forwards}
    @keyframes splashLoad{0%{width:0}70%{width:88%}100%{width:100%}}
    #mainScroll{height:100vh;overflow-y:auto;padding-bottom:110px;position:relative}
    #mainScroll.tour-lock{overflow:hidden!important;touch-action:none!important}
    body.tour-lock{overflow:hidden!important}
    .topbar{padding:15px 20px;display:flex;justify-content:space-between;align-items:center;background:0 0;z-index:50}
    .brand{font-family:'Courgette',cursive;font-size:26px;color:var(--primary);text-shadow:0 0 15px rgba(0,210,255,.4)}
    .top-actions{display:flex;align-items:center;gap:10px}
    .icon-btn{
      width:42px;height:42px;border-radius:50%;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:#fff;display:grid;place-items:center;cursor:pointer;
      backdrop-filter:blur(12px);
      position:relative;
    }
    .badge-dot{
      position:absolute;top:6px;right:6px;
      width:10px;height:10px;border-radius:50%;
      background:var(--danger);
      border:2px solid #000;
      display:none;
    }
    .user-badge{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.08);padding:7px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);cursor:pointer;backdrop-filter:blur(12px)}
    .user-badge .badge-icon{width:30px;height:30px;border-radius:50%;display:grid;place-items:center;background:rgba(0,210,255,.12);border:1px solid rgba(0,210,255,.35);color:var(--primary)}
    .user-badge img{width:30px;height:30px;border-radius:50%;border:1px solid var(--primary);object-fit:cover}
    .vibe-score{font-size:13px;font-weight:800;color:var(--viby);display:flex;align-items:center;gap:6px}
    .badge-text{display:flex;flex-direction:column;line-height:1.05}
    .badge-title{font-size:12px;font-weight:900;color:#fff}
    .badge-sub{font-size:10px;color:rgba(255,255,255,.55);margin-top:2px}
    .event-banner{padding:0 15px;margin-bottom:20px}
    .event-banner img{width:100%;height:90px;object-fit:cover;border-radius:20px;border:1px solid var(--border);box-shadow:0 5px 20px rgba(0,0,0,.5);display:block}
    .feed{padding:0 15px 15px 15px;display:flex;flex-direction:column;gap:25px}
    .post-card{background:var(--card);border-radius:24px;border:1px solid var(--border);overflow:hidden;position:relative}
    .post-header{padding:12px 15px;display:flex;align-items:center;justify-content:space-between;background:rgba(0,0,0,.2);min-height:64px}
    .post-user-info{display:flex;align-items:center;gap:10px}
    .p-avatar{width:42px;height:42px;border-radius:50%;border:2px solid #333;object-fit:cover;cursor:pointer}
    .p-name{font-size:14px;font-weight:700;color:#fff;cursor:pointer;display:flex;align-items:center;gap:8px}
    .rank-tag{font-size:9px;font-weight:900;padding:2px 6px;border-radius:4px;text-transform:uppercase;color:#000;letter-spacing:.5px}
    .rank-rookie{background:#a0a0a0}
    .rank-gold{background:linear-gradient(45deg,#ffd700,#fff)}
    .rank-legend{background:linear-gradient(45deg,#00d2ff,#fff)}
    .p-loc{font-size:11px;color:var(--muted)}
    .delete-btn{background:0 0;border:none;color:var(--danger);cursor:pointer;padding:5px;display:flex;align-items:center}
    .post-visual{width:100%;min-height:350px;display:flex;align-items:center;justify-content:center;background:#000;position:relative}
    .post-visual img{width:100%;display:block;object-fit:cover}
    .bg-text{font-size:24px;font-weight:800;text-align:center;padding:20px;color:#fff;text-shadow:0 4px 15px rgba(0,0,0,.6)}
    .img-caption{position:absolute;bottom:0;left:0;width:100%;padding:60px 15px 15px;background:linear-gradient(to top,rgba(0,0,0,.9),transparent);color:#fff;font-size:15px;font-weight:500;pointer-events:none;z-index:10}
    .post-actions{padding:12px 15px;display:flex;justify-content:space-between;border-top:1px solid var(--border);background:#0a0a0a;align-items:center;z-index:20;position:relative}
    .vote-box{display:flex;align-items:center;background:#1a1a1a;border-radius:20px;padding:4px;gap:8px;border:1px solid var(--border)}
    .vote-btn{background:0 0;border:none;padding:6px 8px;color:#666;cursor:pointer;display:flex;align-items:center;transition:.2s}
    .vote-btn.up.active{color:var(--success)}
    .vote-btn.down.active{color:var(--danger)}
    .vote-val{font-size:14px;font-weight:800;min-width:20px;text-align:center;color:#fff}
    .action-btn{background:rgba(255,255,255,.05);border:1px solid var(--border);color:#fff;padding:8px 16px;border-radius:20px;font-size:12px;font-weight:600;display:flex;align-items:center;gap:6px;cursor:pointer}
    .rooms-layout{padding:0 20px 20px 20px}
    .city-header{display:flex;align-items:center;gap:10px;margin:25px 0 15px;border-bottom:1px solid var(--border);padding-bottom:10px}
    .city-icon{color:var(--primary);width:24px;height:24px}
    .city-title{font-size:22px;font-weight:900;color:#fff;text-transform:uppercase;letter-spacing:1px}
    .hood-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .hood-item{background:linear-gradient(145deg,#1a1a1a,#111);border:1px solid var(--border);padding:20px;border-radius:16px;text-align:center;cursor:pointer;position:relative;overflow:hidden;transition:.2s}
    .hood-item:active{transform:scale(.96);border-color:var(--primary)}
    .hood-name{font-size:14px;font-weight:700;z-index:2;position:relative}
    .online-dot{width:8px;height:8px;background:#00ff9d;border-radius:50%;position:absolute;top:10px;right:10px;box-shadow:0 0 8px #00ff9d}
    .dock-wrapper{position:fixed;bottom:22px;left:0;right:0;display:flex;justify-content:center;pointer-events:none;z-index:100}
    .dock{pointer-events:auto;background:rgba(18,18,18,.92);backdrop-filter:blur(22px);border:1px solid rgba(255,255,255,.14);border-radius:999px;padding:12px 18px;display:flex;align-items:center;gap:14px;box-shadow:0 20px 70px rgba(0,0,0,.75)}
    .dock-btn{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.10);color:rgba(255,255,255,.70);display:flex;align-items:center;gap:10px;font-size:12px;font-weight:900;cursor:pointer;border-radius:999px;padding:10px 14px;transition:.2s}
    .dock-btn svg{width:20px;height:20px}
    .dock-btn.active{color:#000;background:linear-gradient(135deg,#00d2ff,#007aff);border-color:transparent}
    .fab-main{pointer-events:auto;width:58px;height:58px;border-radius:50%;background:linear-gradient(135deg,#00d2ff,#007aff);box-shadow:0 14px 40px rgba(0,210,255,.32);display:grid;place-items:center;color:#fff;border:none;cursor:pointer;margin:0 6px;transform:translateY(-22px);border:5px solid var(--bg);transition:transform .2s}
    .fab-main svg{width:26px;height:26px}
    .fab-main:active{transform:translateY(-22px) scale(.95)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:3500;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(10px)}
    .modal-card{background:#161b22;width:100%;max-width:420px;border-radius:24px;padding:20px;border:1px solid var(--border);display:flex;flex-direction:column;max-height:85vh;box-shadow:0 20px 60px rgba(0,0,0,.8)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid var(--border)}
    .close-btn{background:0 0;border:none;color:#fff;font-size:24px;cursor:pointer}
    .scroll-content{flex:1;overflow-y:auto;margin-bottom:15px}
    .audio-player{display:flex;align-items:center;gap:10px;background:linear-gradient(145deg,#1e1e1e,#161616);border:1px solid rgba(255,255,255,.1);padding:8px 12px;border-radius:25px;width:fit-content;margin-top:5px;cursor:pointer;transition:all .2s ease;box-shadow:0 2px 5px rgba(0,0,0,.2)}
    .audio-player.playing{border-color:var(--primary);background:rgba(0,210,255,.1)}
    .audio-btn{width:28px;height:28px;border-radius:50%;background:var(--primary);display:grid;place-items:center;color:#000;flex-shrink:0;transition:.2s}
    .audio-player.playing .audio-btn{background:var(--viby);box-shadow:0 0 10px var(--viby)}
    .audio-wave{display:flex;align-items:center;gap:3px;height:16px}
    .bar{width:3px;height:4px;background:#666;border-radius:2px;transition:.2s}
    .audio-player.playing .bar{background:var(--primary);animation:soundWave .8s infinite ease-in-out alternate}
    .audio-player.playing .bar:nth-child(1){animation-delay:0s}
    .audio-player.playing .bar:nth-child(2){animation-delay:.2s}
    .audio-player.playing .bar:nth-child(3){animation-delay:.4s}
    .audio-player.playing .bar:nth-child(4){animation-delay:.1s}
    .audio-text{font-size:11px;font-weight:700;color:#aaa;margin-left:5px}
    .audio-player.playing .audio-text{color:var(--primary)}
    @keyframes soundWave{0%{height:4px}100%{height:16px}}
    /* ✅ audio time label */
    .audio-time{
      font-size:11px;
      font-weight:800;
      color:rgba(255,255,255,.55);
      margin-left:10px;
      min-width:68px;
      text-align:right;
    }
    .audio-player.playing .audio-time{color:var(--viby)}
    .comment-item{display:flex;gap:10px;margin-bottom:15px;align-items:flex-start}
    .c-avatar{width:34px;height:34px;border-radius:50%;object-fit:cover;cursor:pointer;border:1px solid var(--border)}
    .c-content{flex:1}
    .c-bubble{background:#222;padding:10px 14px;border-radius:12px;border:1px solid var(--border);display:inline-block;min-width:150px}
    .c-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
    .c-user{font-weight:700;color:var(--primary);font-size:12px;cursor:pointer}
    .c-time{font-size:10px;color:var(--muted)}
    .c-text{font-size:14px;color:#eee;line-height:1.4}
    .chat-interface{position:fixed;inset:0;background:#000;z-index:3000;display:flex;flex-direction:column}
    .chat-top{padding:15px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:15px;background:#111}
    .chat-exit{background:0 0;border:none;color:var(--danger);display:flex;align-items:center;cursor:pointer}
    .chat-scroll{flex:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:10px}
    .msg-row{display:flex;gap:10px;max-width:85%;align-items:flex-end}
    .msg-row.me{align-self:flex-end;flex-direction:row-reverse}
    .msg-img{width:32px;height:32px;border-radius:50%;border:1px solid #333;object-fit:cover}
    .msg-box{padding:8px 12px;border-radius:12px;background:#1a1a1a;border:1px solid var(--border);position:relative}
    .msg-row.me .msg-box{background:rgba(0,210,255,.15);border-color:var(--primary)}
    .msg-user{font-size:11px;font-weight:700;color:var(--primary);margin-bottom:4px;display:block}
    .msg-time{font-size:9px;color:rgba(255,255,255,.5);text-align:right;margin-top:4px;display:block}
    .chat-controls{padding:10px;background:#111;border-top:1px solid var(--border)}
    .input-row{display:flex;gap:10px;align-items:center}
    .chat-input{flex:1;background:#000;border:1px solid var(--border);padding:12px 15px;border-radius:25px;color:#fff}
    .circle-btn{width:42px;height:42px;border-radius:50%;border:1px solid var(--border);background:#222;color:#fff;display:grid;place-items:center;cursor:pointer;flex-shrink:0;transition:.2s}
    .circle-btn.recording{background:var(--danger);border-color:var(--danger);box-shadow:0 0 15px var(--danger);animation:pulse 1s infinite}
    .send-btn{width:42px;height:42px;border-radius:50%;background:var(--primary);border:none;display:grid;place-items:center;cursor:pointer;color:#000}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
    .prof-view{text-align:center}
    .prof-lg{width:100px;height:100px;border-radius:50%;border:3px solid var(--primary);object-fit:cover;margin-bottom:10px}
    .prof-rank-badge{display:inline-block;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:900;text-transform:uppercase;margin-bottom:10px;color:#000;letter-spacing:1px}
    .prof-bio{font-size:14px;color:#ccc;margin-bottom:14px;font-style:italic;line-height:1.4;padding:0 15px}
    .prof-status{
      font-size:12px;
      font-weight:900;
      color:var(--danger); /* ✅ الأحمر */
      margin:-4px 0 14px;
    }
    .stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px}
    .stat-box{background:#222;padding:15px;border-radius:12px;border:1px solid var(--border)}
    .info-list{text-align:left;background:#1a1a1a;padding:15px;border-radius:16px;border:1px solid var(--border)}
    .info-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #333;font-size:14px}
    .edit-profile-btn{background:var(--primary);color:#000;border:none;padding:10px 20px;border-radius:10px;font-weight:800;cursor:pointer;margin-top:15px;width:100%;display:none}
    .form-input{width:100%;background:#000;border:1px solid var(--border);color:#fff;padding:14px;border-radius:12px;margin-bottom:12px}
    .btn-primary{width:100%;padding:15px;background:var(--primary);border:none;border-radius:12px;font-weight:800;cursor:pointer;color:#000}
    #bgOptions{display:flex;gap:15px;margin-bottom:15px;overflow-x:auto;padding-bottom:5px;align-items:center}
    .bg-circle{width:45px;height:45px;border-radius:50%;flex-shrink:0;cursor:pointer;border:2px solid transparent;transition:.2s}
    .bg-circle.selected{border-color:#fff;transform:scale(1.1)}
    .upload-tools{display:flex;gap:10px;align-items:center}
    .tool-btn{width:45px;height:45px;border-radius:50%;background:#222;border:1px solid var(--border);display:grid;place-items:center;color:#fff;cursor:pointer;flex-shrink:0}
    /* ✅ Inbox list UI */
    .thread-item{
      display:flex;gap:10px;align-items:center;
      padding:12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      margin-bottom:10px;
      cursor:pointer;
    }
    .thread-item:active{transform:scale(.99)}
    .thread-avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid rgba(255,255,255,.18)}
    .thread-meta{flex:1;min-width:0}
    .thread-name{font-weight:900;font-size:13px;color:#fff;display:flex;align-items:center;gap:8px}
    .thread-preview{font-size:11px;color:rgba(255,255,255,.62);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .thread-time{font-size:10px;color:rgba(255,255,255,.45);font-weight:900}
    :root{--maxW:1100px}
    #mainScroll{scrollbar-gutter:stable}
    .post-visual{min-height:260px;height:clamp(260px,55vw,420px)}
    .post-visual img{width:100%;height:100%;object-fit:cover}
    .sponsored-pill{font-size:10px;font-weight:900;letter-spacing:.6px;text-transform:uppercase;padding:4px 12px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:rgba(255,255,255,.88)}
    .ad-header{position:relative;justify-content:center}
    .sponsored-center{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);pointer-events:none}
    .ad-visual{background:linear-gradient(180deg,rgba(0,210,255,.10),rgba(0,0,0,0));padding:14px}
    .ad-shell{background:#0b0f14;border:1px solid rgba(255,255,255,.10);border-radius:18px;overflow:hidden;min-height:180px;display:flex;align-items:center;justify-content:center;padding:10px}
    .ad-link{display:block;width:100%;height:100%;border-radius:14px;overflow:hidden}
    .ad-img{width:100%;height:auto;max-height:260px;object-fit:contain;display:block;border-radius:14px;opacity:0;transform:translateY(6px);transition:opacity .35s ease, transform .35s ease}
    .ad-img.in{opacity:1;transform:translateY(0)}
    .gate-card{background:radial-gradient(120% 120% at 10% 0%, rgba(0,210,255,.18), rgba(0,0,0,0)), #0b0f14;border:1px solid rgba(255,255,255,.14);border-radius:26px;max-width:420px;width:100%;padding:18px;box-shadow:0 30px 90px rgba(0,0,0,.85)}
    .gate-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .gate-title{font-size:16px;font-weight:900;color:#fff}
    .gate-sub{font-size:13px;color:rgba(255,255,255,.66);line-height:1.5;margin-bottom:14px}
    .gate-avatar{width:84px;height:84px;border-radius:50%;margin:10px auto 14px;display:grid;place-items:center;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);box-shadow:0 12px 40px rgba(0,0,0,.55)}
    .gate-google{width:100%;border:none;cursor:pointer;border-radius:16px;padding:14px 14px;font-weight:900;font-size:14px;display:flex;align-items:center;justify-content:center;gap:10px;background:linear-gradient(135deg,#00d2ff,#007aff);color:#000;box-shadow:0 14px 40px rgba(0,210,255,.25)}
    .gate-google img{width:20px;height:20px;background:#fff;border-radius:50%;padding:2px}
    .gate-tiktok{margin:12px auto 0;display:flex;align-items:center;justify-content:center;gap:10px;color:#fff;text-decoration:none;font-weight:900;font-size:12px;width:fit-content;padding:10px 14px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)}
    .gate-tiktok svg{width:16px;height:16px;fill:#fff;stroke:none}
    .tour-overlay{position:fixed;inset:0;z-index:4200;display:none}
    .tour-dim{position:absolute;inset:0;pointer-events:none;opacity:1;transition:opacity .45s ease}
    .tour-dim::before{content:"";position:absolute;inset:0;background:rgba(0,0,0,.55);-webkit-mask-image:radial-gradient(circle at var(--tx,50%) var(--ty,30%), transparent 0, transparent calc(var(--tr,110px) - 2px), #000 calc(var(--tr,110px) + 2px));mask-image:radial-gradient(circle at var(--tx,50%) var(--ty,30%), transparent 0, transparent calc(var(--tr,110px) - 2px), #000 calc(var(--tr,110px) + 2px));transition:all .65s cubic-bezier(.2,.9,.2,1)}
    .tour-dim::after{content:"";position:absolute;left:0;right:0;bottom:0;height:38vh;background:linear-gradient(0deg, rgba(0,0,0,.78) 0%, rgba(0,0,0,.35) 55%, rgba(0,0,0,0) 100%);filter:blur(14px);opacity:.85}
    .tour-ring{position:fixed;left:var(--tx,50%);top:var(--ty,30%);transform:translate(-50%,-50%);width:calc(var(--tr,110px)*2);height:calc(var(--tr,110px)*2);border-radius:999px;border:2px solid rgba(0,210,255,.55);box-shadow:0 0 0 6px rgba(0,210,255,.10), 0 35px 120px rgba(0,210,255,.22);pointer-events:none;z-index:4205;transition:left .75s cubic-bezier(.18,.88,.22,1), top .75s cubic-bezier(.18,.88,.22,1), width .75s cubic-bezier(.18,.88,.22,1), height .75s cubic-bezier(.18,.88,.22,1);animation:ringGlow 1.25s ease-in-out infinite}
    @keyframes ringGlow{0%,100%{opacity:.92;transform:translate(-50%,-50%) scale(1)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.03)}}
    .tour-arrow{position:fixed;left:var(--ax,50%);top:var(--ay,50%);transform:translate(-50%,-50%) rotate(var(--ar,0deg));z-index:4210;pointer-events:none;transition:left .78s cubic-bezier(.16,.9,.22,1), top .78s cubic-bezier(.16,.9,.22,1), transform .78s cubic-bezier(.16,.9,.22,1);animation:arrowPulse 1.05s ease-in-out infinite}
    @keyframes arrowPulse{0%,100%{filter:drop-shadow(0 10px 30px rgba(0,210,255,.22))}50%{filter:drop-shadow(0 14px 40px rgba(0,210,255,.35))}}
    .tour-arrow svg{width:78px;height:78px;fill:none;stroke:rgba(0,210,255,.95);stroke-width:8;stroke-linecap:round;stroke-linejoin:round}
    .tour-box{width:min(520px,92vw);background:radial-gradient(120% 120% at 0% 0%, rgba(0,210,255,.22), rgba(0,0,0,0)), rgba(12,14,18,.92);border:1px solid rgba(255,255,255,.14);border-radius:22px;padding:16px 16px 14px;box-shadow:0 35px 90px rgba(0,0,0,.9);position:fixed;left:50%;transform:translateX(-50%);top:var(--tby, 120px);z-index:4212;transition:top .78s cubic-bezier(.16,.9,.22,1), transform .78s cubic-bezier(.16,.9,.22,1), opacity .45s ease}
    .tour-title{font-size:15px;font-weight:1000;letter-spacing:.2px}
    .tour-desc{margin-top:8px;font-size:13px;color:rgba(255,255,255,.72);line-height:1.55}
    .tour-actions{display:flex;justify-content:space-between;align-items:center;margin-top:14px;gap:10px}
    .tour-progress{font-size:11px;color:rgba(255,255,255,.5);font-weight:800}
    .tour-ok{border:none;cursor:pointer;border-radius:14px;padding:12px 14px;font-weight:1000;font-size:12px;background:linear-gradient(135deg,#00d2ff,#007aff);color:#000;min-width:120px;box-shadow:0 14px 40px rgba(0,210,255,.22)}
    .tour-skip{border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.05);color:#fff;border-radius:14px;padding:12px 14px;font-weight:900;font-size:12px;cursor:pointer}
    .tour-style-0 .tour-ring,.tour-style-0 .tour-box,.tour-style-0 .tour-arrow{transition-timing-function:cubic-bezier(.16,.9,.22,1)}
    .tour-style-1 .tour-ring,.tour-style-1 .tour-box,.tour-style-1 .tour-arrow{transition-timing-function:cubic-bezier(.15,1.05,.2,1)}
    .tour-style-2 .tour-ring,.tour-style-2 .tour-box,.tour-style-2 .tour-arrow{transition-timing-function:cubic-bezier(.12,.88,.28,1)}
    @media (min-width:768px){
      #mainScroll{padding-bottom:150px}
      .topbar,.event-banner,.rooms-layout{max-width:var(--maxW);margin-left:auto;margin-right:auto}
      .topbar{padding:18px 24px}
      .event-banner{padding:0 24px;margin-bottom:22px}
      .event-banner img{height:110px}
      .feed{max-width:var(--maxW);margin:0 auto;padding:0 24px 24px 24px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:22px}
      .post-card{border-radius:22px}
      .post-visual{height:clamp(220px,32vh,420px)}
      .img-caption{font-size:14px;padding:60px 18px 16px}
      .post-header{padding:14px 16px}
      .post-actions{padding:14px 16px}
      .hood-grid{grid-template-columns:repeat(3,1fr);gap:14px}
      .hood-item{padding:22px}
      .dock{gap:14px;padding:12px 14px}
      .modal-card{max-width:520px}
    }
    @media (min-width:1100px){
      .feed{grid-template-columns:repeat(3,minmax(0,1fr))}
      .hood-grid{grid-template-columns:repeat(4,1fr)}
      .post-visual{height:clamp(220px,28vh,380px)}
      .event-banner img{height:130px}
    }
  </style>
  <script>
    const sb=supabase.createClient("https://tujdnvnrizgqroaozsqp.supabase.co","sb_publishable_WyigevxmzR2gLtbog2Ztfg_8pdmSwop",{auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:true,flowType:"pkce"}});
    let session,currentBg,currentPostId,currentRoomKey=null,currentRoomLabel=null,roomSub=null,currentPlayingBtn=null,myProfile={},isEditing=!1,currentEditingUser=null,seenRoomMsgIds=new Set,roomProfileCache={},profileRequired=!1,roomPollTimer=null,lastRoomCreatedAt=null;
    // ✅ DM state
    let currentDMUserId=null;
    let currentDMThreadId=null;
    let dmSub=null;
    let dmPollTimer=null;
    let lastDMCAt=null;
    let seenDMMsgIds=new Set();
    // ✅ presence heartbeat
    let presenceTimer=null;
    let dmInboxBadgeTimer=null;
    const globalAudio=document.getElementById("globalAudio");
    const TIKTOK_URL="https://www.tiktok.com/@hypezone.ma";
    const AD_IMAGE="https://i.postimg.cc/rwTFC8C7/Tik-Tok.png";
    // ✅ AUDIO RECORDER STATE
    let hzRecorder=null;
    let hzStream=null;
    let hzChunks=[];
    let hzRecordingTarget=null; // "room" | "comment" | "dm"
    let hzIsUploading=false;
    // ✅ CHANGE THIS IF YOU WANT A DEDICATED BUCKET NAME
    const AUDIO_BUCKET="post_images";
    const AUDIO_FOLDER="audio";
    // ✅ TABLE NAMES (you must create these in Supabase)
    const TBL_DM="dm_messages";
    const TBL_PRESENCE="user_presence";
    const cities={
      rabat:{name:"Rabat",hoods:["Agdal","Hassan","Hay Riad","Ocean","Medina","Souissi","Yacoub Al Mansour","Akkari","Kammra","Temara","Skhirat"]},
      sale:{name:"Sale",hoods:["Diar","Hay Chmaaou","Opera","Wad Adahab","Bab Lmrissa","Tabriquet","Sala Al Jadida","Hay Salam","Bettana","Sidi Moussa"]},
      casablanca:{name:"Casablanca",hoods:["Maarif","Anfa","Ain Diab","Gauthier","Bourgogne","Racine","Sidi Maarouf","Hay Hassani","Ain Sebaa","Sidi Bernoussi","Oulfa","California","Beausejour","Derb Sultan","Mers Sultan","Belvedere","Hay Mohammadi","Sbata","Ben M'Sick","Lissasfa","Zenata"]},
      marrakech:{name:"Marrakech",hoods:["Gueliz","Hivernage","Medina","Sidi Ghanem","Agdal","Targa","Daoudiate","Semlalia","Bab Doukkala","Bab Aylan","Mellah","Palmeraie"]},
      fes:{name:"Fes",hoods:["Fes El Bali","Fes El Jdid","Ville Nouvelle","Narjiss","Agdal","Zouagha","Sidi Boujida","Bensouda","Saiss"]},
      tangier:{name:"Tangier",hoods:["Malabata","Iberia","Marshan","Medina","California","Boukhalef","Mghogha","Bni Makada","Achakar"]},
      agadir:{name:"Agadir",hoods:["Talborjt","Founty","Agadir Bay","Anza","Dakhla","Bensergao","Tilila","Hay Mohammadi","Ait Melloul","Inezgane"]},
      meknes:{name:"Meknes",hoods:["Hamria","Medina","Borj Moulay Omar","Marjane","Wislane","Sidi Bouzekri","Toulal","Zitoune"]},
      oujda:{name:"Oujda",hoods:["Hay Al Qods","Hay Salam","Sidi Yahya","Centre Ville","Lazaret","Al Andalous","Hay Najd"]},
      kenitra:{name:"Kenitra",hoods:["Maamora","Bir Rami","Saknia","Centre Ville","Val Fleuri","Oulad Oujih","Mimosas"]},
      tetouan:{name:"Tetouan",hoods:["Medina","Ensanche","Sania Rmel","Bouanan","Touilaa","Martil"]},
      eljadida:{name:"El Jadida",hoods:["Centre Ville","Sidi Bouzid","Hay Salam","Cite Portugaise","Najd","Azemmour"]},
      safi:{name:"Safi",hoods:["Ville Nouvelle","Medina","Sidi Bouzid","Jorf","Errahma","Hay Salam"]},
      mohammedia:{name:"Mohammedia",hoods:["Centre Ville","Mansouria","Fadila","Hay Salam","Al Wafa","Kasbah"]},
      nador:{name:"Nador",hoods:["Centre Ville","Selouane","Beni Ensar","Al Aaroui","Bouarg"]},
      benimellal:{name:"Beni Mellal",hoods:["Centre Ville","Hay Salam","Aghbala Road","Kasbah Ras El Ain","Ouled Yaich"]},
      khouribga:{name:"Khouribga",hoods:["Centre Ville","Hay Salam","OCP","Fqih Ben Salah Road"]},
      taza:{name:"Taza",hoods:["Ville Nouvelle","Medina","Bab El Qarmoud","Bab El Gharbi"]},
      essaouira:{name:"Essaouira",hoods:["Medina","New Town","Diabat","Borj","Mellah"]},
      laayoune:{name:"Laayoune",hoods:["Centre Ville","Maatallah","Al Massira","Hay Salam","El Wifaq"]},
      dakhla:{name:"Dakhla",hoods:["City Center","Al Wahda","Al Matar","Al Qassam"]}
    };
    const cityOrder=["rabat","sale","casablanca","marrakech","fes","tangier","agadir","meknes","oujda","kenitra","tetouan","eljadida","safi","mohammedia","nador","benimellal","khouribga","taza","essaouira","laayoune","dakhla"];
    const gradients=["linear-gradient(45deg,#ff9a9e,#fecfef)","linear-gradient(120deg,#84fab0,#8fd3f4)","linear-gradient(to top,#30cfd0,#330867)","linear-gradient(to right,#434343,black)","linear-gradient(to top,#fcc5e4,#020f75)"];
    function lockTourScroll(on){
      const ms=document.getElementById("mainScroll");
      if(on){document.body.classList.add("tour-lock");ms.classList.add("tour-lock")}
      else{document.body.classList.remove("tour-lock");ms.classList.remove("tour-lock")}
    }
    function roomKey(cityKey,hood){return cityKey+"|"+hood}
    function parseHoodValue(v){const t=(v||"").split("|");return t.length>=2?{cityKey:t[0]||"rabat",hood:t[1]||"Agdal"}:{cityKey:"rabat",hood:(v||"Agdal")}}
    function cityInHoodLabel(cityKey,hood){const n=cities[cityKey]?cities[cityKey].name:"Rabat";return n+" in "+hood}
    function profileLoc(p){
      if(!p) return {cityName:"Rabat",hood:"Agdal"};
      const t=(p.neighborhood||"");
      if(t.includes("|")){
        const n=parseHoodValue(t);
        return {cityName:(cities[n.cityKey]?cities[n.cityKey].name:"Rabat"),hood:n.hood}
      }
      return {cityName:(p.city||"Rabat"),hood:(t||"Agdal")}
    }
    function showLoginGate(){document.getElementById("loginGate").style.display="flex"}
    function requireAuth(){if(session&&session.user&&session.user.id) return true; showLoginGate(); return false}
    function requireProfile(){
      if(!session||!session.user) return false;
      if(profileRequired){openMandatorySetup(); return false}
      if(!myProfile||!myProfile.id){openMandatorySetup(); return false}
      return true
    }
    // ✅ DM thread id (deterministic)
    function dmThreadId(a,b){
      const x=String(a||"");
      const y=String(b||"");
      return (x<y) ? `${x}_${y}` : `${y}_${x}`;
    }
    function renderTopRight(){
      const e=document.getElementById("topRightBadge");
      if(!e) return;
      if(session&&session.user&&session.user.id && myProfile && myProfile.id && !profileRequired){
        e.onclick=()=>openProfile(session.user.id);
        e.innerHTML=`<img id="myAvatar" alt="My avatar" src="${myProfile.avatar_url||""}"><span class="vibe-score"><svg style="width:14px;height:14px;color:var(--viby)"><use href="#i-bolt-filled"></use></svg><span id="myScore">${myProfile.vibe_score||0}</span></span>`
      }else{
        e.onclick=()=>{session&&session.user?openMandatorySetup():showLoginGate()};
        e.innerHTML=`<span class="badge-icon"><svg style="width:18px;height:18px"><use href="#i-user-strong"></use></svg></span><span class="badge-text"><span class="badge-title">Guest</span><span class="badge-sub">guest</span></span>`
      }
    }
    function buildSponsoredCard(idx){
      const adId=`adSlot_${Date.now()}_${idx}_${Math.floor(1e6*Math.random())}`;
      return `<div class="post-card" data-ad="1"><div class="post-header ad-header"><div class="sponsored-center"><span class="sponsored-pill">Sponsored</span></div></div><div class="ad-visual"><div class="ad-shell"><a class="ad-link" href="${TIKTOK_URL}" rel="nofollow"><img class="ad-img" data-adimg="1" data-adid="${adId}" src="${AD_IMAGE}" alt="Sponsored"></a></div></div></div>`
    }
    let adObserver=null;
    function mountAds(){
      const imgs=[...document.querySelectorAll('img[data-adimg="1"]')];
      if(!imgs.length) return;
      const show=(img)=>{if(!img.classList.contains("in")) img.classList.add("in")};
      if("IntersectionObserver" in window){
        if(!adObserver){
          adObserver=new IntersectionObserver(entries=>{
            entries.forEach(ent=>{
              if(ent.isIntersecting){
                show(ent.target);
                adObserver.unobserve(ent.target);
              }
            })
          },{root:null,threshold:0.15});
        }
        imgs.forEach(img=>{
          if(img.classList.contains("in")) return;
          const r=img.getBoundingClientRect();
          if(r.bottom>0 && r.top<window.innerHeight) show(img);
          else adObserver.observe(img);
        });
      }else imgs.forEach(show);
    }
    function typeSplash(){
      const el=document.getElementById("splashTyped");
      const txt="HypeZone";
      el.textContent="";
      let i=0;
      const total=1200;
      const step=Math.max(20,Math.floor(total/txt.length));
      const timer=setInterval(()=>{
        i++;
        el.textContent=txt.slice(0,i);
        if(i>=txt.length) clearInterval(timer);
      },step);
    }
    function showSplashThenStart(){
      const splash=document.getElementById("splash");
      splash.style.display="flex";
      lockTourScroll(true);
      typeSplash();
      setTimeout(()=>{
        splash.style.display="none";
        const first=localStorage.getItem("hz_tour_v2")!=="1";
        if(first){
          buildTourSteps();
          startTour();
        }else lockTourScroll(false);
      },1500)
    }
    async function handleOAuthRedirect(){
      const url=new URL(window.location.href);
      const hasCode=url.searchParams.get("code");
      const hasError=url.searchParams.get("error")||url.searchParams.get("error_description");
      if(hasError) return;
      if(hasCode){
        try{await sb.auth.exchangeCodeForSession(window.location.href)}catch(e){}
        url.searchParams.delete("code");
        url.searchParams.delete("state");
        url.searchParams.delete("error");
        url.searchParams.delete("error_description");
        window.history.replaceState({},document.title,url.toString());
      }
    }
    function getRank(score){return score<50?{name:"ROOKIE",cls:"rank-rookie"}:score<1000?{name:"GOLD",cls:"rank-gold"}:{name:"LEGEND",cls:"rank-legend"}}
    function timeAgo(d){const t=Math.floor((new Date-new Date(d))/1000);if(t<60)return"Just now";const m=Math.floor(t/60);if(m<60)return m+"m";const h=Math.floor(m/60);return h<24?h+"h":Math.floor(h/24)+"d"}
    function formatChatTime(d){return new Date(d).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}
    function escapeHtml(s){return s?s.replace(/&/g,"&amp;").replace(/</g,"&lt;"):""}
    function closeModal(id){if(profileRequired && id==="setupModal") return; document.getElementById(id).style.display="none"}
    function switchView(view,btn){
      document.querySelectorAll(".dock-btn").forEach(e=>e.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById("feedView").classList.add("hidden");
      document.getElementById("roomsView").classList.add("hidden");
      document.getElementById(view+"View").classList.remove("hidden");
    }
    function renderCities(){
      const e=document.getElementById("citiesWrap"); if(!e) return;
      e.innerHTML="";
      cityOrder.forEach(k=>{
        const n=cities[k]; if(!n) return;
        const header=document.createElement("div");
        header.className="city-header";
        header.innerHTML=`<svg class="city-icon"><use href="#i-gps"></use></svg><span class="city-title">${n.name.toUpperCase()}</span>`;
        const grid=document.createElement("div");
        grid.className="hood-grid"; grid.id=k+"Grid";
        n.hoods.forEach(h=>{
          grid.innerHTML+=`<div class="hood-item" onclick="openRoom('${k}','${h}')"><div class="online-dot"></div><div class="hood-name">${h}</div></div>`;
        });
        e.appendChild(header); e.appendChild(grid);
      });
    }
    function renderGradients(){
      const e=document.getElementById("bgOptions");
      gradients.forEach(t=>e.innerHTML+=`<div class="bg-circle" style="background:${t}" onclick="setBg('${t}', this)"></div>`);
    }
    function setBg(v,el){
      currentBg=v;
      document.querySelectorAll(".bg-circle").forEach(e=>e.classList.remove("selected"));
      el&&el.classList.add("selected");
    }
    function renderSetupHoods(){
      const e=document.getElementById("setupHood"); if(!e) return;
      e.innerHTML="";
      cityOrder.forEach(k=>{
        const n=cities[k]; if(!n) return;
        const g=document.createElement("optgroup"); g.label=n.name;
        n.hoods.forEach(h=>{
          const o=document.createElement("option");
          o.value=roomKey(k,h); o.textContent=h;
          g.appendChild(o);
        });
        e.appendChild(g);
      });
      e.value=roomKey("rabat","Agdal");
    }
    function openMandatorySetup(){
      if(!session||!session.user) return;
      profileRequired=true;
      document.getElementById("setupTitle").innerText="Create Profile";
      document.getElementById("setupCloseBtn").style.display="none";
      document.getElementById("setupModal").style.display="flex";
      document.getElementById("setupUser").disabled=false;
      document.getElementById("setupUser").value="";
      document.getElementById("setupFull").value="";
      document.getElementById("setupGender").value="Male";
      document.getElementById("setupInterests").value="";
      document.getElementById("setupBio").value="";
      document.getElementById("setupHood").value=roomKey("rabat","Agdal");
      document.getElementById("setupAvatarImg").style.display="none";
      document.getElementById("setupFile").value="";
      lockTourScroll(true);
    }
    function openEditProfile(){
      if(!requireAuth()) return;
      if(profileRequired) return openMandatorySetup();
      isEditing=true;
      const e=currentEditingUser||myProfile;
      document.getElementById("profileModal").style.display="none";
      document.getElementById("setupModal").style.display="flex";
      document.getElementById("setupTitle").innerText="Edit Profile";
      document.getElementById("setupCloseBtn").style.display="block";
      document.getElementById("setupUser").value=e.username||"";
      document.getElementById("setupUser").disabled=true;
      document.getElementById("setupFull").value=e.full_name||"";
      document.getElementById("setupGender").value=e.gender||"Male";
      document.getElementById("setupInterests").value=e.interests||"";
      document.getElementById("setupBio").value=e.bio||"";
      const t=(e.neighborhood||"");
      if(t.includes("|")) document.getElementById("setupHood").value=t;
      else document.getElementById("setupHood").value=roomKey((e.city||"Rabat").toLowerCase(),(t||"Agdal"));
      document.getElementById("setupAvatarImg").src=e.avatar_url||"";
      document.getElementById("setupAvatarImg").style.display=e.avatar_url?"block":"none";
      document.getElementById("setupFile").value="";
    }
    function previewSetupImg(inp){
      if(inp.files&&inp.files[0]){
        document.getElementById("setupAvatarImg").src=URL.createObjectURL(inp.files[0]);
        document.getElementById("setupAvatarImg").style.display="block";
      }
    }
    async function ensureUsernameUnique(u){
      const username=(u||"").trim();
      if(!username) return false;
      const {data}=await sb.from("profiles").select("id").eq("username",username).limit(1);
      if(data && data.length){
        if(isEditing && myProfile && myProfile.username===username) return true;
        return false;
      }
      return true;
    }
    async function saveProfileChanges(){
      if(!requireAuth()) return;
      const btn=document.getElementById("setupSaveBtn");
      btn.disabled=true; btn.textContent="Saving...";
      const username=(document.getElementById("setupUser").value||"").trim();
      const displayName=(document.getElementById("setupFull").value||"").trim();
      const gender=document.getElementById("setupGender").value;
      const interests=(document.getElementById("setupInterests").value||"").trim();
      const hoodVal=document.getElementById("setupHood").value;
      const bio=(document.getElementById("setupBio").value||"").trim();
      const file=document.getElementById("setupFile").files[0] || null;
      if(!username || username.length<3){btn.disabled=false;btn.textContent="Save Profile";return alert("Username required (min 3 chars)");}
      if(!displayName){btn.disabled=false;btn.textContent="Save Profile";return alert("Display Name required");}
      if(!interests){btn.disabled=false;btn.textContent="Save Profile";return alert("Interests required");}
      if(!hoodVal){btn.disabled=false;btn.textContent="Save Profile";return alert("City & neighborhood required");}
      const unique=await ensureUsernameUnique(username);
      if(!unique){btn.disabled=false;btn.textContent="Save Profile";return alert("Username already taken");}
      let avatarUrl=(myProfile&&myProfile.avatar_url)||"";
      if(profileRequired && !file && !avatarUrl){btn.disabled=false;btn.textContent="Save Profile";return alert("Avatar required");}
      if(file){
        if(avatarUrl && avatarUrl.includes("/storage/") && avatarUrl.includes("/avatars/")){
          const old=avatarUrl.split("/").pop();
          if(old) await sb.storage.from("avatars").remove([old]);
        }
        const key=`${session.user.id}-${Date.now()}`;
        await sb.storage.from("avatars").upload(key,file,{upsert:true});
        const {data:o}=sb.storage.from("avatars").getPublicUrl(key);
        avatarUrl=o.publicUrl;
      }
      const parsed=parseHoodValue(hoodVal);
      const payload={
        id:session.user.id,
        username,
        full_name:displayName,
        gender,
        interests,
        bio,
        neighborhood:roomKey(parsed.cityKey,parsed.hood),
        avatar_url:avatarUrl
      };
      const {error}=await sb.from("profiles").upsert(payload);
      if(error){btn.disabled=false;btn.textContent="Save Profile";return alert(error.message);}
      profileRequired=false;
      isEditing=false;
      document.getElementById("setupModal").style.display="none";
      lockTourScroll(false);
      await checkProfile();
      renderTopRight();
      loadFeed();
    }
    async function checkProfile(){
      if(!session||!session.user) return;
      const {data}=await sb.from("profiles").select("*").eq("id",session.user.id).maybeSingle();
      if(data && data.id && data.username && data.avatar_url && data.full_name && data.gender && data.interests && data.neighborhood){
        myProfile=data;
        profileRequired=false;
      }else{
        myProfile=data||{};
        profileRequired=true;
        openMandatorySetup();
      }
      renderTopRight();
    }
    async function loadFeed(){
      const e=document.getElementById("feedList");
      e.innerHTML="<div style='text-align:center;color:#666'>Loading...</div>";
      
      // ✅ FIX: TIMEOUT PROMISE
      const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 5000));
      try {
        const {data} = await Promise.race([
           sb.from("posts").select("*, profiles(*)").order("created_at",{ascending:false}),
           timeout
        ]);
        
        e.innerHTML="";
        const posts=(data||[]);
        let adEvery=4+Math.floor(Math.random()*3);
        let rendered=0;
        posts.forEach(p=>{
          const u=p.profiles, r=getRank(u.vibe_score||0), isMine=session&&session.user&&session.user.id===u.id;
          const loc=profileLoc(u);
          const locLabel=loc.cityName+" in "+loc.hood;
          const visual=p.background_style
            ?`<div class="post-visual" style="background:${p.background_style}"><div class="bg-text">${escapeHtml(p.caption)}</div></div>`
            :`<div class="post-visual"><img src="${p.image_url}"><div class="img-caption">${escapeHtml(p.caption)}</div></div>`;
          e.innerHTML+=`<div class="post-card"><div class="post-header"><div class="post-user-info"><img class="p-avatar" src="${u.avatar_url}" onclick="openProfile('${u.id}')"><div onclick="openProfile('${u.id}')"><div class="p-name">${u.username} <span class="rank-tag ${r.cls}">${r.name}</span></div><div class="p-loc">${locLabel} • ${timeAgo(p.created_at)}</div></div></div>${isMine?`<button class="delete-btn" onclick="deletePost('${p.id}')"><svg><use href="#i-trash"></use></svg></button>`:""}</div>${visual}<div class="post-actions"><div class="vote-box"><button class="vote-btn up" onclick="vote('${p.id}', 1)"><svg><use href="#i-up"></use></svg></button><span class="vote-val">${u.vibe_score||0}</span><button class="vote-btn down" onclick="vote('${p.id}', -1)"><svg><use href="#i-down"></use></svg></button></div><button class="action-btn" onclick="openComments('${p.id}')"><svg style="width:16px"><use href="#i-chat"></use></svg> Comments</button></div></div>`;
          rendered++;
          if(rendered%adEvery===0){
            e.innerHTML+=buildSponsoredCard(rendered);
            adEvery=4+Math.floor(Math.random()*3);
          }
        });
        if(rendered<3) e.innerHTML+=buildSponsoredCard(0);
        mountAds();
      } catch (err) {
        e.innerHTML="<div style='text-align:center;color:#666'>Tap to retry</div>";
        e.onclick = () => loadFeed();
      }
    }
    async function openComments(id){
      if(!requireAuth()) return;
      if(!requireProfile()) return;
      currentPostId=id;
      document.getElementById("commentsModal").style.display="flex";
      loadPostComments();
    }
    const _durCache = new Map();
    function fmtTime(sec){
      sec = Math.max(0, Math.floor(sec || 0));
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${m}:${String(s).padStart(2,'0')}`;
    }
    function setPlayerTime(el, current, duration){
      if(!el) return;
      const t = el.querySelector(".audio-time");
      if(!t) return;
      if(duration && isFinite(duration)){
        t.textContent = `${fmtTime(current)} / ${fmtTime(duration)}`;
      }else{
        t.textContent = fmtTime(current);
      }
    }
    function hydrateAudioDurations(root){
      const wrap = root || document;
      const items = [...wrap.querySelectorAll(".audio-player[data-audio]")];
      if(!items.length) return;
      items.forEach(el=>{
        const url = el.getAttribute("data-audio");
        if(!url) return;
        if(_durCache.has(url)){
          setPlayerTime(el, 0, _durCache.get(url));
          return;
        }
        setPlayerTime(el, 0, 0);
        try{
          const a = new Audio();
          a.preload = "metadata";
          a.crossOrigin = "anonymous";
          a.src = url;
          a.onloadedmetadata = () => {
            const d = (a.duration && isFinite(a.duration)) ? a.duration : 0;
            if(d>0){
              _durCache.set(url, d);
              setPlayerTime(el, 0, d);
            } else {
              setPlayerTime(el, 0, 0);
            }
            a.src = "";
          };
          a.onerror = () => { a.src = ""; };
        }catch(e){}
      });
    }
    async function loadPostComments(){
      const e=document.getElementById("postCommentsList");
      e.innerHTML="Loading...";
      const {data}=await sb.from("comments").select("*, profiles(*)").eq("post_id",currentPostId).order("created_at");
      e.innerHTML="";
      (data||[]).forEach(c=>{
        const visual=c.audio_url
          ?`<div class="audio-player" data-audio="${c.audio_url}" onclick="playAudio('${c.audio_url}', this)">
              <div class="audio-btn"><svg style="width:14px;height:14px;fill:#000;stroke:none"><use href="#i-play"></use></svg></div>
              <div class="audio-wave"><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
              <span class="audio-text">Voice</span><span class="audio-time">0:00</span>
            </div>`
          :`<div class="c-text">${escapeHtml(c.text_content)}</div>`;
        e.innerHTML+=`<div class="comment-item"><img class="c-avatar" src="${c.profiles.avatar_url}" onclick="openProfile('${c.profiles.id}')"><div class="c-content"><div class="c-bubble"><div class="c-header"><span class="c-user" onclick="openProfile('${c.profiles.id}')">${c.profiles.username}</span><span class="c-time">${timeAgo(c.created_at)}</span></div>${visual}</div></div></div>`;
      });
      hydrateAudioDurations(e);
    }
    function playAudio(url,el){
      if(!url || !el) return;
      if(currentPlayingBtn===el && !globalAudio.paused){
        globalAudio.pause();
        resetPlayerUI(el);
        return;
      }
      if(currentPlayingBtn && currentPlayingBtn!==el) resetPlayerUI(currentPlayingBtn);
      currentPlayingBtn=el;
      globalAudio.onloadedmetadata=()=>{ setPlayerTime(el, 0, globalAudio.duration); };
      globalAudio.ontimeupdate=()=>{
        if(currentPlayingBtn===el){
          setPlayerTime(el, globalAudio.currentTime, globalAudio.duration);
        }
      };
      globalAudio.onended=()=>{
        if(currentPlayingBtn){
          resetPlayerUI(currentPlayingBtn, true);
          currentPlayingBtn=null;
        }
      };
      globalAudio.src=url;
      globalAudio.currentTime=0;
      globalAudio.play().then(()=>{
        el.classList.add("playing");
        el.querySelector(".audio-btn").innerHTML='<svg style="width:14px;height:14px;fill:#000;stroke:none"><use href="#i-pause"></use></svg>';
        el.querySelector(".audio-text").innerText="Playing";
        setPlayerTime(el, 0, globalAudio.duration);
      }).catch(()=>{
        resetPlayerUI(el);
      });
    }
    function resetPlayerUI(el, ended=false){
      if(!el) return;
      el.classList.remove("playing");
      const btn=el.querySelector(".audio-btn");
      if(btn) btn.innerHTML='<svg style="width:14px;height:14px;fill:#000;stroke:none"><use href="#i-play"></use></svg>';
      const txt=el.querySelector(".audio-text");
      if(txt) txt.innerText="Voice";
      const url = el.getAttribute("data-audio");
      const dur = url && _durCache.has(url) ? _durCache.get(url) : ((globalAudio && isFinite(globalAudio.duration)) ? globalAudio.duration : 0);
      setPlayerTime(el, 0, dur);
    }
    function previewFile(){
      const f=document.getElementById("postFile").files[0];
      if(!f) return;
      document.getElementById("imgPreview").src=URL.createObjectURL(f);
      document.getElementById("imgPreview").style.display="block";
    }
    function openCreate(){
      if(!requireAuth()) return;
      if(!requireProfile()) return;
      document.getElementById("createModal").style.display="flex";
    }
    async function submitPost(){
      if(!requireAuth()) return;
      if(!requireProfile()) return;
      const cap=document.getElementById("postCap").value;
      const f=document.getElementById("postFile").files[0];
      let url=null;
      if(!currentBg && !f) return alert("Select background or image");
      if(f && !currentBg){
        const key=`${Date.now()}-${Math.floor(Math.random()*1e6)}`;
        await sb.storage.from("post_images").upload(key,f,{upsert:true});
        url=sb.storage.from("post_images").getPublicUrl(key).data.publicUrl;
      }
      await sb.from("posts").insert({user_id:session.user.id,caption:cap,image_url:url,background_style:currentBg});
      document.getElementById("createModal").style.display="none";
      loadFeed();
    }
    async function deletePost(id){
      if(!requireAuth()) return;
      if(!requireProfile()) return;
      if(!confirm("Delete this vibe?")) return;
      await sb.from("posts").delete().eq("id",id);
      loadFeed();
    }
    async function vote(postId,type){
      if(!requireAuth()) return;
      if(!requireProfile()) return;
      const {data:existing}=await sb.from("post_votes").select("*").eq("user_id",session.user.id).eq("post_id",postId).maybeSingle();
      if(existing){
        if(existing.vote_type===type) await sb.from("post_votes").delete().eq("id",existing.id);
        else await sb.from("post_votes").update({vote_type:type}).eq("id",existing.id);
      }else{
        await sb.from("post_votes").insert({user_id:session.user.id,post_id:postId,vote_type:type});
      }
      loadFeed();
    }
    // ✅ presence helpers
    async function upsertPresence(isOnline){
      if(!session || !session.user) return;
      try{
        await sb.from(TBL_PRESENCE).upsert({
          user_id: session.user.id,
          is_online: !!isOnline,
          last_seen: new Date().toISOString()
        });
      }catch(e){}
    }
    function startPresence(){
      stopPresence();
      if(!session || !session.user) return;
      upsertPresence(true);
      presenceTimer=setInterval(()=>upsertPresence(true), 25000);
      window.addEventListener("beforeunload", ()=>{ try{ upsertPresence(false); }catch(e){} }, {once:true});
      window.addEventListener("pagehide", ()=>{ try{ upsertPresence(false); }catch(e){} }, {once:true});
    }
    function stopPresence(){
      if(presenceTimer){clearInterval(presenceTimer); presenceTimer=null;}
    }
    async function fetchPresence(userId){
      try{
        const {data}=await sb.from(TBL_PRESENCE).select("*").eq("user_id", userId).maybeSingle();
        return data||null;
      }catch(e){ return null; }
    }
    function presenceLabel(p){
      if(p && p.is_online) return "Active Now";
      if(p && p.last_seen) return "Last seen " + timeAgo(p.last_seen);
      return "Last seen";
    }
    function contactFromProfile(){
      if(!currentEditingUser || !currentEditingUser.id) return;
      closeModal("profileModal");
      openDM(currentEditingUser.id);
    }
    async function openProfile(id){
      if(!requireAuth()) return;
      if(!requireProfile()) return;
      const modal=document.getElementById("profileModal");
      modal.style.display="flex";
      const {data:p}=await sb.from("profiles").select("*").eq("id",id).single();
      currentEditingUser=p;
      const {count:postsCount}=await sb.from("posts").select("*",{count:"exact",head:true}).eq("user_id",id);
      const r=getRank(p.vibe_score||0);
      const loc=profileLoc(p);
      const pres = await fetchPresence(id);
      document.getElementById("vpStatus").innerText = presenceLabel(pres);
      document.getElementById("vpImg").src=p.avatar_url||"";
      document.getElementById("vpName").innerText=p.username||"";
      document.getElementById("vpRankBadge").innerText=r.name;
      document.getElementById("vpRankBadge").className=`prof-rank-badge ${r.cls}`;
      document.getElementById("vpBio").innerText=p.bio||"No bio yet.";
      document.getElementById("vpScore").innerText=p.vibe_score||0;
      document.getElementById("vpPosts").innerText=postsCount||0;
      document.getElementById("vpCity").innerText=loc.cityName||"-";
      document.getElementById("vpHood").innerText=loc.hood||"-";
      document.getElementById("vpAge").innerText=p.age||"-";
      document.getElementById("vpGender").innerText=p.gender||"-";
      document.getElementById("vpInterests").innerText=p.interests||"-";
      const isMine = session.user.id===id;
      document.getElementById("editProfileBtn").style.display=isMine?"block":"none";
      document.getElementById("contactBtn").style.display=!isMine?"block":"none";
    }
    function stopRoomLive(){
      if(roomSub){sb.removeChannel(roomSub);roomSub=null}
      if(roomPollTimer){clearInterval(roomPollTimer);roomPollTimer=null}
      lastRoomCreatedAt=null;
    }
    async function fetchProfileMini(userId){
      if(roomProfileCache[userId]) return roomProfileCache[userId];
      const {data}=await sb.from("profiles").select("id, username, avatar_url").eq("id",userId).maybeSingle();
      if(data){roomProfileCache[userId]=data; return data}
      return {id:userId,username:"User",avatar_url:""}
    }
    function renderOneMessage(msg,prof){
      const n=document.getElementById("chatMsgs");
      const me=session&&session.user&&msg.user_id===session.user.id;
      const u=prof||{username:"User",avatar_url:""};
      const body=msg.audio_url
        ?`<div class="audio-player" data-audio="${msg.audio_url}" onclick="playAudio('${msg.audio_url}', this)">
            <div class="audio-btn"><svg style="width:14px;height:14px;fill:#000;stroke:none"><use href="#i-play"></use></svg></div>
            <div class="audio-wave"><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
            <span class="audio-text">Voice</span><span class="audio-time">0:00</span>
          </div>`
        :`<div class="msg-content">${escapeHtml(msg.content||"")}</div>`;
      n.insertAdjacentHTML("beforeend",`<div class="msg-row ${me?"me":""}">${me?"":`<img class="msg-img" src="${u.avatar_url||""}" onclick="openProfile('${msg.user_id}')">`}<div class="msg-box">${me?"":`<span class="msg-user">${u.username||"User"}</span>`}${body}<span class="msg-time">${formatChatTime(msg.created_at)}</span></div></div>`);
      n.scrollTop=n.scrollHeight;
      hydrateAudioDurations(n);
    }
    async function handleNewRoomMessage(row){
      if(!row || !row.id) return;
      if(row.room_name!==currentRoomKey) return;
      if(seenRoomMsgIds.has(row.id)) return;
      seenRoomMsgIds.add(row.id);
      lastRoomCreatedAt=row.created_at||lastRoomCreatedAt;
      const prof=await fetchProfileMini(row.user_id);
      renderOneMessage(row,prof);
    }
    async function subscribeRoom(roomName){
      stopRoomLive();
      roomSub=sb.channel("room:"+roomName)
        .on("postgres_changes",{event:"INSERT",schema:"public",table:"room_chats",filter:`room_name=eq.${roomName}`},payload=>{handleNewRoomMessage(payload.new)})
        .subscribe();
      roomPollTimer=setInterval(async ()=>{
        if(!currentRoomKey) return;
        const since=lastRoomCreatedAt||new Date(0).toISOString();
        const {data:rows}=await sb.from("room_chats").select("*").eq("room_name",currentRoomKey).gt("created_at",since).order("created_at",{ascending:true});
        if(!rows||!rows.length) return;
        const fresh=rows.filter(r=>r.id && !seenRoomMsgIds.has(r.id));
        if(!fresh.length) return;
        const ids=[...new Set(fresh.map(r=>r.user_id).filter(Boolean))].filter(id=>!roomProfileCache[id]);
        if(ids.length){
          const {data:plist}=await sb.from("profiles").select("id, username, avatar_url").in("id",ids);
          (plist||[]).forEach(p=>{roomProfileCache[p.id]=p});
        }
        fresh.forEach(r=>{
          seenRoomMsgIds.add(r.id);
          lastRoomCreatedAt=r.created_at||lastRoomCreatedAt;
          renderOneMessage(r,roomProfileCache[r.user_id]||{username:"User",avatar_url:""});
        });
      },900);
    }
    async function openRoom(cityKey,hood){
      currentRoomKey=roomKey(cityKey,hood);
      currentRoomLabel=cityInHoodLabel(cityKey,hood);
      document.getElementById("chatRoom").classList.remove("hidden");
      document.getElementById("roomNameDisplay").innerText=currentRoomLabel;
      seenRoomMsgIds=new Set();
      roomProfileCache={};
      lastRoomCreatedAt=null;
      
      // ✅ FIX: TIMEOUT AND ERROR HANDLING
      try {
        await loadRoomMsgs();
        await subscribeRoom(currentRoomKey);
      } catch(e) {
         // silently fail or show retry
         document.getElementById("chatMsgs").innerHTML = `<div style="text-align:center;color:#666;margin-top:20px">Connection weak. <span style="text-decoration:underline;cursor:pointer" onclick="openRoom('${cityKey}','${hood}')">Tap to retry</span></div>`;
      }
    }
    async function loadRoomMsgs(){
      const box=document.getElementById("chatMsgs");
      box.innerHTML="Loading...";
      // ✅ TIMEOUT PROMISE
      const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 4000));
      const {data} = await Promise.race([
          sb.from("room_chats").select("*").eq("room_name",currentRoomKey).order("created_at",{ascending:true}),
          timeout
      ]);
      
      box.innerHTML="";
      const rows=data||[];
      const ids=[...new Set(rows.map(r=>r.user_id))];
      if(ids.length){
        const {data:plist}=await sb.from("profiles").select("id, username, avatar_url").in("id",ids);
        (plist||[]).forEach(p=>{roomProfileCache[p.id]=p});
      }
      rows.forEach(r=>{
        if(r.id) seenRoomMsgIds.add(r.id);
        renderOneMessage(r,roomProfileCache[r.user_id]);
      });
      const last=rows[rows.length-1];
      lastRoomCreatedAt=last?last.created_at:null;
      box.scrollTop=box.scrollHeight;
      hydrateAudioDurations(box);
    }
    async function sendRoomMsg(){
      const text=(document.getElementById("roomInput").value||"").trim();
      if(!text || !currentRoomKey) return;
      if(!requireAuth()) return;
      if(!requireProfile()) return;
      document.getElementById("roomInput").value="";
      const {data:row,error}=await sb.from("room_chats").insert({room_name:currentRoomKey,user_id:session.user.id,content:text}).select("*").single();
      if(error) return;
      if(row && row.id){
        if(!seenRoomMsgIds.has(row.id)){
          seenRoomMsgIds.add(row.id);
          lastRoomCreatedAt=row.created_at||lastRoomCreatedAt;
          renderOneMessage(row,myProfile&&myProfile.id?{id:myProfile.id,username:myProfile.username,avatar_url:myProfile.avatar_url}:{username:"Me",avatar_url:""});
        }
      }
    }
    async function sendPostComment(){
      const text=(document.getElementById("commentInput").value||"").trim();
      if(!text || !currentPostId) return;
      if(!requireAuth()) return;
      if(!requireProfile()) return;
      document.getElementById("commentInput").value="";
      const {error}=await sb.from("comments").insert({post_id:currentPostId,user_id:session.user.id,text_content:text});
      if(error) return alert(error.message);
      loadPostComments();
    }
    function stopDMChannelOnly(){
      if(dmSub){sb.removeChannel(dmSub);dmSub=null}
      if(dmPollTimer){clearInterval(dmPollTimer);dmPollTimer=null}
    }
    function stopDMLive(){
      stopDMChannelOnly();
      lastDMCAt=null;
      currentDMUserId=null;
      currentDMThreadId=null;
      seenDMMsgIds=new Set();
    }
    async function openDM(otherUserId){
      if(!requireAuth()) return;
      if(!requireProfile()) return;
      currentDMUserId=otherUserId;
      currentDMThreadId=dmThreadId(session.user.id, otherUserId);
      document.getElementById("dmChat").classList.remove("hidden");
      const {data:prof}=await sb.from("profiles").select("id,username,avatar_url").eq("id", otherUserId).maybeSingle();
      document.getElementById("dmNameDisplay").innerText = (prof && prof.username) ? prof.username : "User";
      const pres = await fetchPresence(otherUserId);
      document.getElementById("dmStatusDisplay").innerText = presenceLabel(pres);
      seenDMMsgIds=new Set();
      lastDMCAt=null;
      try {
        await loadDMMessages();
        await subscribeDM(currentDMThreadId);
      } catch(e) {
        // fail silently
      }
    }
    function renderDMMessage(row, otherProfile){
      const box=document.getElementById("dmMsgs");
      const me = row.sender_id===session.user.id;
      const u = otherProfile || {username:"User", avatar_url:""};
      const body=row.audio_url
        ?`<div class="audio-player" data-audio="${row.audio_url}" onclick="playAudio('${row.audio_url}', this)">
            <div class="audio-btn"><svg style="width:14px;height:14px;fill:#000;stroke:none"><use href="#i-play"></use></svg></div>
            <div class="audio-wave"><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
            <span class="audio-text">Voice</span><span class="audio-time">0:00</span>
          </div>`
        :`<div class="msg-content">${escapeHtml(row.content||"")}</div>`;
      box.insertAdjacentHTML("beforeend",
        `<div class="msg-row ${me?"me":""}">
          ${me?"":`<img class="msg-img" src="${u.avatar_url||""}" onclick="openProfile('${u.id}')">`}
          <div class="msg-box">
            ${me?"":`<span class="msg-user">${u.username||"User"}</span>`}
            ${body}
            <span class="msg-time">${formatChatTime(row.created_at)}</span>
          </div>
        </div>`
      );
      box.scrollTop=box.scrollHeight;
      hydrateAudioDurations(box);
    }
    async function loadDMMessages(){
      const box=document.getElementById("dmMsgs");
      box.innerHTML="Loading...";
      const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 4000));
      
      const {data:otherP}=await sb.from("profiles").select("id, username, avatar_url").eq("id", currentDMUserId).maybeSingle();
      const {data:rows}=await Promise.race([
        sb.from(TBL_DM).select("*").eq("thread_id", currentDMThreadId).order("created_at",{ascending:true}),
        timeout
      ]);
        
      box.innerHTML="";
      (rows||[]).forEach(r=>{
        if(r.id) seenDMMsgIds.add(r.id);
        renderDMMessage(r, otherP);
      });
      const last=(rows||[])[(rows||[]).length-1];
      lastDMCAt = last ? last.created_at : null;
      box.scrollTop=box.scrollHeight;
      hydrateAudioDurations(box);
    }
    async function handleNewDM(row){
      if(!row || !row.id) return;
      if(row.thread_id!==currentDMThreadId) return;
      if(seenDMMsgIds.has(row.id)) return;
      seenDMMsgIds.add(row.id);
      lastDMCAt = row.created_at || lastDMCAt;
      const {data:otherP}=await sb.from("profiles").select("id, username, avatar_url").eq("id", currentDMUserId).maybeSingle();
      renderDMMessage(row, otherP);
    }
    async function subscribeDM(threadId){
      stopDMChannelOnly();
      currentDMThreadId = threadId;
      dmSub=sb.channel("dm:"+threadId)
        .on("postgres_changes",{event:"INSERT",schema:"public",table:TBL_DM,filter:`thread_id=eq.${threadId}`},payload=>{handleNewDM(payload.new)})
        .subscribe();
      dmPollTimer=setInterval(async ()=>{
        if(!currentDMThreadId) return;
        const since=lastDMCAt||new Date(0).toISOString();
        const {data:rows}=await sb.from(TBL_DM)
          .select("*")
          .eq("thread_id", currentDMThreadId)
          .gt("created_at", since)
          .order("created_at",{ascending:true});
        if(!rows||!rows.length) return;
        const fresh=rows.filter(r=>r.id && !seenDMMsgIds.has(r.id));
        if(!fresh.length) return;
        const {data:otherP}=await sb.from("profiles").select("id, username, avatar_url").eq("id", currentDMUserId).maybeSingle();
        fresh.forEach(r=>{
          seenDMMsgIds.add(r.id);
          lastDMCAt = r.created_at || lastDMCAt;
          renderDMMessage(r, otherP);
        });
      },900);
    }
    async function sendDMMsg(){
      const text=(document.getElementById("dmInput").value||"").trim();
      if(!text || !currentDMUserId || !currentDMThreadId) return;
      if(!requireAuth()) return;
      if(!requireProfile()) return;
      document.getElementById("dmInput").value="";
      const payload={
        thread_id: currentDMThreadId,
        sender_id: session.user.id,
        receiver_id: currentDMUserId,
        content: text,
        audio_url: null
      };
      const {data:row,error}=await sb.from(TBL_DM).insert(payload).select("*").single();
      if(error) return;
      if(row && row.id && !seenDMMsgIds.has(row.id)){
        seenDMMsgIds.add(row.id);
        lastDMCAt=row.created_at||lastDMCAt;
        const {data:otherP}=await sb.from("profiles").select("id, username, avatar_url").eq("id", currentDMUserId).maybeSingle();
        renderDMMessage(row, otherP);
      }
    }
    async function openInbox(){
      if(!requireAuth()) return;
      if(!requireProfile()) return;
      document.getElementById("inboxModal").style.display="flex";
      await loadInbox();
    }
    async function loadInbox(){
      const box=document.getElementById("inboxList");
      box.innerHTML="Loading...";
      const uid = session.user.id;
      const {data:rows, error}=await sb.from(TBL_DM)
        .select("*")
        .or(`sender_id.eq.${uid},receiver_id.eq.${uid}`)
        .order("created_at",{ascending:false})
        .limit(300);
      if(error){
        box.innerHTML="<div style='color:#666'>Inbox unavailable (create dm_messages table first).</div>";
        return;
      }
      const msgs = rows||[];
      if(!msgs.length){
        box.innerHTML="<div style='text-align:center;color:#666'>No messages yet.</div>";
        return;
      }
      const latestByThread=new Map();
      msgs.forEach(m=>{
        if(!m.thread_id) return;
        if(!latestByThread.has(m.thread_id)) latestByThread.set(m.thread_id, m);
      });
      const threads=[...latestByThread.values()];
      const otherIds=[...new Set(threads.map(t=>{
        const other = (t.sender_id===uid) ? t.receiver_id : t.sender_id;
        return other;
      }).filter(Boolean))];
      let profMap={};
      if(otherIds.length){
        const {data:plist}=await sb.from("profiles").select("id, username, avatar_url").in("id", otherIds);
        (plist||[]).forEach(p=>{profMap[p.id]=p});
      }
      box.innerHTML="";
      threads.forEach(t=>{
        const otherId = (t.sender_id===uid) ? t.receiver_id : t.sender_id;
        const p = profMap[otherId] || {id:otherId, username:"User", avatar_url:""};
        const preview = t.audio_url ? "Voice message" : (t.content||"");
        box.innerHTML +=
          `<div class="thread-item" onclick="closeModal('inboxModal');openDM('${otherId}')">
            <img class="thread-avatar" src="${p.avatar_url||""}" alt="">
            <div class="thread-meta">
              <div class="thread-name">${p.username||"User"}</div>
              <div class="thread-preview">${escapeHtml(preview)}</div>
            </div>
            <div class="thread-time">${timeAgo(t.created_at)}</div>
          </div>`;
      });
      const dot=document.getElementById("inboxDot");
      if(dot) dot.style.display="none";
    }
    async function startInboxBadge(){
      stopInboxBadge();
      if(!session || !session.user) return;
      const uid=session.user.id;
      let lastCheck=new Date().toISOString();
      dmInboxBadgeTimer=setInterval(async ()=>{
        try{
          const since = lastCheck;
          lastCheck = new Date().toISOString();
          const {data}=await sb.from(TBL_DM)
            .select("id,receiver_id,created_at")
            .eq("receiver_id", uid)
            .gt("created_at", since)
            .order("created_at",{ascending:false})
            .limit(1);
          if(data && data.length){
            const dot=document.getElementById("inboxDot");
            if(dot) dot.style.display="block";
          }
        }catch(e){}
      }, 2500);
    }
    function stopInboxBadge(){
      if(dmInboxBadgeTimer){clearInterval(dmInboxBadgeTimer); dmInboxBadgeTimer=null;}
    }
    function uaInfo(){
      const ua=navigator.userAgent||"";
      const isAndroid=/Android/i.test(ua);
      const isIOS=/iPhone|iPad|iPod/i.test(ua);
      const isChrome=/Chrome|CriOS/i.test(ua) && !/Edg/i.test(ua);
      const isEdge=/Edg/i.test(ua);
      const isSafari=/Safari/i.test(ua) && !/Chrome|CriOS|Edg/i.test(ua);
      const isFirefox=/Firefox/i.test(ua);
      const isWindows=/Windows/i.test(ua);
      const isMac=/Macintosh/i.test(ua) && !isIOS;
      return {ua,isAndroid,isIOS,isChrome,isEdge,isSafari,isFirefox,isWindows,isMac};
    }
    function micHelpHtml(){
      const i=uaInfo();
      const httpsTip=`<div style="margin-top:10px;color:rgba(255,255,255,.72)"><b>Important:</b> Recording requires <b>HTTPS</b> (not http) and you must tap the mic button inside the page (user gesture).</div>`;
      let html=`<div style="font-size:13px">You can’t send voice because the browser doesn’t have microphone permission (blocked or denied).</div>`;
      if(i.isAndroid && i.isChrome){
        html+=`<div style="margin-top:10px"><b>Android — Chrome</b><br>
        1) Open the website<br>
        2) Tap the lock icon next to the URL<br>
        3) Permissions / Site settings<br>
        4) Microphone = <b>Allow</b><br>
        5) Reload the page</div>`;
      } else if(i.isIOS && i.isSafari){
        html+=`<div style="margin-top:10px"><b>iPhone / iPad — Safari</b><br>
        1) iOS Settings → Safari<br>
        2) Microphone → <b>Allow</b><br>
        3) Return to Safari and tap the mic again<br>
        4) If prompted, choose <b>Allow</b></div>`;
      } else if(i.isWindows && i.isEdge){
        html+=`<div style="margin-top:10px"><b>Windows — Microsoft Edge</b><br>
        1) Click the lock icon next to the URL<br>
        2) Microphone = <b>Allow</b><br>
        3) Reload the page</div>`;
      } else if(i.isWindows && i.isChrome){
        html+=`<div style="margin-top:10px"><b>Windows — Chrome</b><br>
        1) Click the lock icon next to the URL<br>
        2) Site settings<br>
        3) Microphone = <b>Allow</b><br>
        4) Reload</div>`;
      } else if(i.isMac && i.isSafari){
        html+=`<div style="margin-top:10px"><b>macOS — Safari</b><br>
        1) Safari → Settings → Websites → Microphone<br>
        2) For this site: <b>Allow</b><br>
        3) Reload</div>`;
      } else if(i.isFirefox){
        html+=`<div style="margin-top:10px"><b>Firefox</b><br>
        1) Click the lock/info icon near the URL<br>
        2) Permissions → Microphone → <b>Allow</b><br>
        3) Reload</div>`;
      } else {
        html+=`<div style="margin-top:10px"><b>General steps</b><br>
        1) Open site permissions (lock icon near the URL)<br>
        2) Set Microphone to <b>Allow</b><br>
        3) Reload the page</div>`;
      }
      html+=httpsTip;
      return html;
    }
    function showMicPermModal(){
      document.getElementById("micPermBody").innerHTML=micHelpHtml();
      document.getElementById("micPermModal").style.display="flex";
    }
    function bestMimeType(){
      const candidates=[
        "audio/webm;codecs=opus",
        "audio/webm",
        "audio/ogg;codecs=opus",
        "audio/ogg",
        "audio/mp4"
      ];
      for(const t of candidates){
        try{ if(window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) return t; }catch(e){}
      }
      return "";
    }
    function extFromMime(m){
      if(!m) return "webm";
      if(m.includes("ogg")) return "ogg";
      if(m.includes("mp4")) return "mp4";
      return "webm";
    }
    async function ensureMicAllowedOrPrompt(){
      try{
        if(navigator.permissions && navigator.permissions.query){
          const st=await navigator.permissions.query({name:"microphone"});
          if(st && st.state==="denied") return false;
        }
      }catch(e){}
      return true;
    }
    async function startRecording(target,btnEl){
      if(hzIsUploading) return;
      if(!requireAuth()) return;
      if(!requireProfile()) return;
      if(target==="room" && !currentRoomKey) return;
      if(target==="comment" && !currentPostId) return;
      if(target==="dm" && (!currentDMUserId || !currentDMThreadId)) return;
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        showMicPermModal();
        return;
      }
      const ok=await ensureMicAllowedOrPrompt();
      if(!ok){
        showMicPermModal();
        return;
      }
      try{
        hzStream=await navigator.mediaDevices.getUserMedia({audio:true});
      }catch(err){
        showMicPermModal();
        return;
      }
      const mime=bestMimeType();
      try{
        hzChunks=[];
        hzRecordingTarget=target;
        hzRecorder=new MediaRecorder(hzStream, mime?{mimeType:mime}:{});
      }catch(err){
        stopTracksSafe(hzStream); hzStream=null;
        showMicPermModal();
        return;
      }
      hzRecorder.ondataavailable=(e)=>{ if(e.data && e.data.size>0) hzChunks.push(e.data); };
      hzRecorder.onstop=async ()=>{
        try{
          const type=(hzRecorder && hzRecorder.mimeType) ? hzRecorder.mimeType : (mime||"audio/webm");
          const blob=new Blob(hzChunks,{type});
          hzChunks=[];
          await uploadAndSendAudio(blob,type,target,btnEl);
        }catch(e){
          alert("Failed to send audio. Try again.");
        }finally{
          if(btnEl) btnEl.classList.remove("recording");
          stopTracksSafe(hzStream); hzStream=null;
          hzRecorder=null;
          hzRecordingTarget=null;
        }
      };
      if(btnEl) btnEl.classList.add("recording");
      try{ hzRecorder.start(); }catch(e){
        if(btnEl) btnEl.classList.remove("recording");
        stopTracksSafe(hzStream); hzStream=null;
        hzRecorder=null;
        hzRecordingTarget=null;
        showMicPermModal();
      }
    }
    function stopRecording(btnEl){
      if(!hzRecorder) return;
      try{
        if(btnEl) btnEl.classList.remove("recording");
        hzRecorder.stop();
      }catch(e){
        if(btnEl) btnEl.classList.remove("recording");
        stopTracksSafe(hzStream); hzStream=null;
        hzRecorder=null;
        hzRecordingTarget=null;
      }
    }
    function stopTracksSafe(stream){
      try{
        if(stream && stream.getTracks) stream.getTracks().forEach(t=>{try{t.stop()}catch(e){}});
      }catch(e){}
    }
    async function uploadAndSendAudio(blob,mime,target,btnEl){
      if(!blob || !blob.size) return;
      if(hzIsUploading) return;
      hzIsUploading=true;
      const prevTitle=btnEl ? btnEl.title : "";
      if(btnEl) btnEl.title="Sending...";
      const ext=extFromMime(mime);
      const key=`${AUDIO_FOLDER}/${session.user.id}-${Date.now()}-${Math.floor(Math.random()*1e6)}.${ext}`;
      const {error:upErr}=await sb.storage.from(AUDIO_BUCKET).upload(key, blob, { upsert:true, contentType:mime||"audio/webm" });
      if(upErr){
        hzIsUploading=false;
        if(btnEl) btnEl.title=prevTitle||"";
        alert("Audio upload failed. Check Storage policies / bucket permissions.");
        return;
      }
      const {data:pub}=sb.storage.from(AUDIO_BUCKET).getPublicUrl(key);
      const audioUrl=pub && pub.publicUrl ? pub.publicUrl : null;
      if(!audioUrl){
        hzIsUploading=false;
        if(btnEl) btnEl.title=prevTitle||"";
        alert("Audio URL failed.");
        return;
      }
      if(target==="room"){
        const {data:row,error}=await sb.from("room_chats")
          .insert({room_name:currentRoomKey,user_id:session.user.id,content:"",audio_url:audioUrl})
          .select("*").single();
        if(error){
          hzIsUploading=false;
          if(btnEl) btnEl.title=prevTitle||"";
          alert("Failed to send audio message.");
          return;
        }
        if(row && row.id && !seenRoomMsgIds.has(row.id)){
          seenRoomMsgIds.add(row.id);
          lastRoomCreatedAt=row.created_at||lastRoomCreatedAt;
          renderOneMessage(row,myProfile&&myProfile.id?{id:myProfile.id,username:myProfile.username,avatar_url:myProfile.avatar_url}:{username:"Me",avatar_url:""});
        }
      }else if(target==="comment"){
        const {error}=await sb.from("comments").insert({post_id:currentPostId,user_id:session.user.id,text_content:"",audio_url:audioUrl});
        if(error){
          hzIsUploading=false;
          if(btnEl) btnEl.title=prevTitle||"";
          alert("Failed to send audio comment.");
          return;
        }
        loadPostComments();
      }else if(target==="dm"){
        const payload={
          thread_id: currentDMThreadId,
          sender_id: session.user.id,
          receiver_id: currentDMUserId,
          content: "",
          audio_url: audioUrl
        };
        const {data:row,error}=await sb.from(TBL_DM).insert(payload).select("*").single();
        if(error){
          hzIsUploading=false;
          if(btnEl) btnEl.title=prevTitle||"";
          alert("Failed to send audio DM.");
          return;
        }
        if(row && row.id && !seenDMMsgIds.has(row.id)){
          seenDMMsgIds.add(row.id);
          lastDMCAt=row.created_at||lastDMCAt;
          const {data:otherP}=await sb.from("profiles").select("id, username, avatar_url").eq("id", currentDMUserId).maybeSingle();
          renderDMMessage(row, otherP);
        }
      }
      hzIsUploading=false;
      if(btnEl) btnEl.title=prevTitle||"";
    }
    function setupMicButtons(){
      const roomBtn=document.getElementById("roomMic");
      const cmtBtn=document.getElementById("commentMicBtn");
      const dmBtn=document.getElementById("dmMic");
      if(roomBtn){
        roomBtn.addEventListener("click", async ()=>{
          if(hzIsUploading) return;
          if(hzRecorder && hzRecordingTarget==="room") stopRecording(roomBtn);
          else{
            if(hzRecorder) stopRecording(hzRecordingTarget==="comment"?document.getElementById("commentMicBtn"):(hzRecordingTarget==="dm"?document.getElementById("dmMic"):roomBtn));
            await startRecording("room",roomBtn);
          }
        },{passive:true});
      }
      if(cmtBtn){
        cmtBtn.addEventListener("click", async ()=>{
          if(hzIsUploading) return;
          if(hzRecorder && hzRecordingTarget==="comment") stopRecording(cmtBtn);
          else{
            if(hzRecorder) stopRecording(hzRecordingTarget==="room"?document.getElementById("roomMic"):(hzRecordingTarget==="dm"?document.getElementById("dmMic"):cmtBtn));
            await startRecording("comment",cmtBtn);
          }
        },{passive:true});
      }
      if(dmBtn){
        dmBtn.addEventListener("click", async ()=>{
          if(hzIsUploading) return;
          if(hzRecorder && hzRecordingTarget==="dm") stopRecording(dmBtn);
          else{
            if(hzRecorder) stopRecording(hzRecordingTarget==="room"?document.getElementById("roomMic"):(hzRecordingTarget==="comment"?document.getElementById("commentMicBtn"):dmBtn));
            await startRecording("dm",dmBtn);
          }
        },{passive:true});
      }
    }
    const tourOverlay=document.getElementById("tourOverlay");
    const tourTitle=document.getElementById("tourTitle");
    const tourDesc=document.getElementById("tourDesc");
    const tourOk=document.getElementById("tourOk");
    const tourSkip=document.getElementById("tourSkip");
    const tourProg=document.getElementById("tourProg");
    let tourStep=0;
    let tourSteps=[];
    let styleIdx=0;
    function buildTourSteps(){
      const firstHood=document.querySelector("#citiesWrap .hood-item");
      tourSteps=[
        {sel:"#topRightBadge",title:"Profile / Login",desc:"Tap here to open your profile. If you are not logged in, you will see a fast Google login popup.",arrow:"down"},
        {sel:"#dockHome",title:"Home Feed",desc:"This is the feed. Scroll to see vibes and sponsored posts.",arrow:"up"},
        {sel:"#dockCreate",title:"Create Post",desc:"Tap + to create a new vibe. If you are not logged in, you will be asked to login.",arrow:"up"},
        {sel:"#dockRooms",title:"Rooms",desc:"Tap Rooms to explore cities and neighborhoods. Join any room instantly.",arrow:"up",action:()=>{const b=document.getElementById("dockRooms");b&&b.click();}},
        {sel:"#citiesWrap",title:"Browse Rooms",desc:"Scroll cities, then tap any neighborhood to enter the room chat.",arrow:"left"},
        {sel:firstHood?null:"#citiesWrap",title:"Join a Room",desc:"Tap a neighborhood card to open its live room. You can read without login, but sending requires login.",arrow:"left",element:firstHood||null},
        {sel:"#dockHome",title:"Back to Feed",desc:"Go back to Home anytime from the dock.",arrow:"up",action:()=>{const b=document.getElementById("dockHome");b&&b.click();}}
      ];
    }
    function startTour(){
      tourStep=0;
      styleIdx=0;
      tourOverlay.style.display="block";
      tourOverlay.classList.remove("tour-style-0","tour-style-1","tour-style-2");
      tourOverlay.classList.add("tour-style-0");
      renderTourStep(true);
      window.addEventListener("resize",()=>renderTourStep(false),{passive:true});
      document.getElementById("mainScroll").addEventListener("scroll",()=>renderTourStep(false),{passive:true});
    }
    function endTour(){
      tourOverlay.style.display="none";
      localStorage.setItem("hz_tour_v2","1");
      lockTourScroll(false);
    }
    function resolveTourTarget(step){if(step.element) return step.element; if(step.sel) return document.querySelector(step.sel); return null}
    function placeArrow(cx,cy,r,dir){
      let ax=cx,ay=cy;
      if(dir==="up"){ay=cy+r+70}
      if(dir==="down"){ay=cy-r-70}
      if(dir==="left"){ax=cx+r+80}
      if(dir==="right"){ax=cx-r-80}
      tourOverlay.style.setProperty("--ax",ax+"px");
      tourOverlay.style.setProperty("--ay",ay+"px");
      let rot=0;
      if(dir==="up") rot=180;
      if(dir==="left") rot=90;
      if(dir==="right") rot=-90;
      tourOverlay.style.setProperty("--ar",rot+"deg");
    }
    function computeBoxTop(cx,cy,r,rect){
      const margin=14;
      const boxH=218;
      const vpad=24;
      const screenH=window.innerHeight;
      const aboveMax=Math.max(vpad, cy-r-boxH-margin);
      const belowMin=Math.min(screenH-boxH-vpad, cy+r+margin);
      const preferBelow=cy<screenH*0.56;
      let top=preferBelow?belowMin:aboveMax;
      top=Math.min(screenH-boxH-vpad, Math.max(vpad, top));
      if(rect){
        const rectBottom=rect.top+rect.height;
        const rectTop=rect.top;
        const boxBottom=top+boxH;
        const overlap=!(boxBottom<rectTop-10 || top>rectBottom+10);
        if(overlap){
          if(rectTop-boxH-margin>vpad) top=rectTop-boxH-margin;
          else if(rectBottom+margin<screenH-boxH-vpad) top=rectBottom+margin;
        }
      }
      return top;
    }
    function renderTourStep(initial){
      if(tourOverlay.style.display!=="block") return;
      const step=tourSteps[tourStep];
      if(!step) return;
      if(step.action && !step._done){
        step._done=true;
        try{step.action()}catch(e){}
        setTimeout(()=>renderTourStep(false),240);
        return;
      }
      const el=resolveTourTarget(step);
      let rect=null;
      if(el && el.getBoundingClientRect) rect=el.getBoundingClientRect();
      if(!rect) rect={left:window.innerWidth*0.5-60,top:window.innerHeight*0.3-60,width:120,height:120};
      const cx=rect.left+rect.width/2;
      const cy=rect.top+rect.height/2;
      const r=Math.max(72,Math.min(170,Math.max(rect.width,rect.height)*0.72));
      tourOverlay.style.setProperty("--tx",cx+"px");
      tourOverlay.style.setProperty("--ty",cy+"px");
      tourOverlay.style.setProperty("--tr",r+"px");
      const top=computeBoxTop(cx,cy,r,rect);
      tourOverlay.style.setProperty("--tby",top+"px");
      tourTitle.textContent=step.title||"Guide";
      tourDesc.textContent=step.desc||"";
      tourProg.textContent=`${tourStep+1}/${tourSteps.length}`;
      placeArrow(cx,cy,r,step.arrow||"down");
      if(!initial){
        styleIdx=(styleIdx+1)%3;
        tourOverlay.classList.remove("tour-style-0","tour-style-1","tour-style-2");
        tourOverlay.classList.add("tour-style-"+styleIdx);
      }
    }
    tourOk.onclick=()=>{tourStep++; if(tourStep>=tourSteps.length){endTour();return} renderTourStep(false)};
    tourSkip.onclick=()=>endTour();
    document.getElementById("gateGoogleBtn").onclick=async()=>{
      const redirectTo=window.location.origin+window.location.pathname;
      await sb.auth.signInWithOAuth({provider:"google",options:{redirectTo,queryParams:{access_type:"offline",prompt:"consent"}}});
    };

    // ===========================================
    // ✅ RESUME MANAGER: THE "HARD RESET" FIX
    // ===========================================
    
    // Force disconnect and reconnect on resume
    async function resumeApp(){
      if(document.hidden) return;
      
      // 1. HARD DISCONNECT (Kill zombie socket)
      sb.realtime.disconnect();
      
      // 2. Refresh Auth if logged in
      if(session){
        const { data: { session: newSession }, error } = await sb.auth.getSession();
        session = newSession;
      }

      // 3. RECONNECT
      setTimeout(async () => {
         sb.realtime.connect();
         
         // 4. Force Reload Active View
         if(currentRoomKey && !document.getElementById('chatRoom').classList.contains('hidden')){
            await loadRoomMsgs(); // Refetch missing messages
            await subscribeRoom(currentRoomKey); // Re-bind
         } else if(currentDMThreadId && !document.getElementById('dmChat').classList.contains('hidden')){
            await loadDMMessages();
            await subscribeDM(currentDMThreadId);
         } else if(!document.getElementById('feedView').classList.contains('hidden')){
           // Optional: refresh feed silently if needed
         }
         
         // Update presence
         startPresence();
         
      }, 300); // Short delay to ensure socket cleared
    }

    async function init(){
      renderCities();
      renderGradients();
      renderSetupHoods();
      renderTopRight();
      loadFeed();
      await handleOAuthRedirect();
      const {data}=await sb.auth.getSession();
      if(data.session){
        session=data.session;
        await checkProfile();
        startPresence();
        startInboxBadge();
      }
      renderTopRight();
      sb.auth.onAuthStateChange(async (evt)=>{
        if(evt==="SIGNED_OUT"){
          try{ await upsertPresence(false); }catch(e){}
          stopPresence();
          stopInboxBadge();
          session=null; myProfile={}; profileRequired=false;
          stopRoomLive();
          stopDMLive();
          renderTopRight();
          loadFeed();
        }
        if(evt==="SIGNED_IN"){
          const {data:sess}=await sb.auth.getSession();
          session=sess.session;
          closeModal("loginGate");
          await checkProfile();
          renderTopRight();
          loadFeed();
          startPresence();
          startInboxBadge();
        }
      });
      setupMicButtons();
      showSplashThenStart();

      // ✅ ADD RESUME LISTENERS
      document.addEventListener("visibilitychange", resumeApp);
      window.addEventListener("pageshow", resumeApp);
      window.addEventListener("focus", resumeApp);
    }
    init();
  </script>
</body>
</html>
